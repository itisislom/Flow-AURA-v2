<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KINEXA Web (Cross-Browser MVP)</title>
  <style>
    body { margin: 0; font-family: system-ui, Arial; background: #0b0e14; color: #e7ecff; }
    .wrap { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 12px; max-width: 1100px; margin: 0 auto; }
    .top { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    button, input[type="file"] { padding:10px 12px; border:0; border-radius:10px; background:#2b62ff; color:white; cursor:pointer; font-weight:600; }
    button.secondary { background:#273046; }
    button.danger { background:#ff3b5c; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .stats { padding:8px 10px; background:#141a27; border-radius:10px; }
    .stage { position: relative; border-radius: 14px; overflow:hidden; background:#05070b; }
    video, canvas { width: 100%; height: auto; display:block; }
    canvas { position:absolute; left:0; top:0; }
    .hint { opacity: .85; font-size: 13px; line-height: 1.35; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > * { flex: 1 1 220px; }
    .err { color:#ff9fb0; font-size: 13px; margin-top: 6px; white-space: pre-wrap; }
    a { color:#9db4ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button id="btnStart">Запустить камеру</button>
      <button id="btnStop" class="secondary" disabled>Стоп</button>

      <button id="btnRec" class="danger" disabled>● Запись</button>
      <button id="btnDownload" class="secondary" disabled>Скачать JSON</button>

      <label class="secondary" style="background:#273046; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer;">
        Загрузить видео
        <input id="fileVideo" type="file" accept="video/*" style="display:none;">
      </label>

      <div class="stats" id="stats">FPS: — | Frames: — | Recording: no</div>
    </div>
    <div id="error" class="err"></div>

    <div class="row">
      <div class="stage">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
      </div>
      <div class="stats">
        <div style="font-weight:700; margin-bottom:6px;">Совместимость</div>
        <div class="hint">
          Камера работает только на <b>HTTPS</b> или <b>localhost</b>.<br/>
          Поддержка: Chrome/Edge/Firefox/Safari (включая iOS).<br/><br/>
          Если камера недоступна — используйте <b>“Загрузить видео”</b>.<br/><br/>
          <b>Совет:</b> встань в кадр целиком (голова–стопы), свет спереди.
        </div>
      </div>
    </div>
  </div>

  <!-- 1) WebRTC adapter polyfill (повышает шанс “в любом браузере”) -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <!-- 2) MediaPipe Pose UMD bundles -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    (function () {
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      var btnStart = document.getElementById('btnStart');
      var btnStop = document.getElementById('btnStop');
      var btnRec = document.getElementById('btnRec');
      var btnDownload = document.getElementById('btnDownload');
      var fileVideo = document.getElementById('fileVideo');

      var statsEl = document.getElementById('stats');
      var errEl = document.getElementById('error');

      var cam = null;
      var pose = null;

      var recording = false;
      var frames = []; // { t, landmarks: [...] }

      var lastTs = performance.now();
      var fps = 0;
      var frameCount = 0;
      var frameCountDelta = 0;

      function showError(msg) {
        errEl.textContent = msg || '';
      }

      function isSecureContextForCamera() {
        // камера требует HTTPS, кроме localhost
        if (location.protocol === 'https:') return true;
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return true;
        return false;
      }

      function hasGetUserMedia() {
        return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      }

      function setStats() {
        statsEl.textContent = 'FPS: ' + fps.toFixed(1) + ' | Frames: ' + frameCount + ' | Recording: ' + (recording ? 'yes' : 'no');
      }

      function resizeCanvas() {
        var w = video.videoWidth || 1280;
        var h = video.videoHeight || 720;
        if (canvas.width !== w) canvas.width = w;
        if (canvas.height !== h) canvas.height = h;
      }

      function draw(results) {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
          drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { lineWidth: 3 });
          drawLandmarks(ctx, results.poseLandmarks, { lineWidth: 2, radius: 3 });

          if (recording) {
            var t = performance.now();
            var lm = results.poseLandmarks.map(function (p) {
              return { x: p.x, y: p.y, z: p.z, visibility: (p.visibility == null ? 0 : p.visibility) };
            });
            frames.push({ t: t, landmarks: lm });
          }
        }

        ctx.restore();

        var now = performance.now();
        var dt = now - lastTs;
        if (dt > 250) {
          fps = 1000 / (dt / (frameCountDelta || 1));
          frameCountDelta = 0;
          lastTs = now;
          setStats();
        }

        frameCount++;
        frameCountDelta++;
      }

      function initPose() {
        pose = new Pose.Pose({
          locateFile: function (file) {
            return 'https://cdn.jsdelivr.net/npm/@mediapipe/pose/' + file;
          }
        });

        // Баланс скорости/качества. Можно сделать селектор позже.
        pose.setOptions({
          modelComplexity: 1, // 0 быстрее, 2 точнее
          smoothLandmarks: true,
          enableSegmentation: false,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });

        pose.onResults(function (results) {
          if (video.videoWidth && video.videoHeight) resizeCanvas();
          draw(results);
        });
      }

      async function startCamera() {
        showError('');

        if (!isSecureContextForCamera()) {
          showError('Ошибка: для доступа к камере нужен HTTPS (или localhost).\nОткрой через локальный сервер или залей на хостинг с HTTPS.');
          return;
        }
        if (!hasGetUserMedia()) {
          showError('Ошибка: браузер не поддерживает getUserMedia.\nИспользуй Chrome/Edge/Firefox/Safari или режим “Загрузить видео”.');
          return;
        }

        btnStart.disabled = true;

        // iOS/Safari капризны к autoplay: делаем явно
        video.setAttribute('playsinline', '');
        video.setAttribute('muted', '');
        video.muted = true;

        initPose();

        cam = new Camera(video, {
          onFrame: async function () {
            try {
              await pose.send({ image: video });
            } catch (e) {
              showError('Pose error: ' + (e && e.message ? e.message : String(e)));
            }
          },
          width: 1280,
          height: 720
        });

        try {
          await cam.start();
        } catch (e) {
          showError('Не удалось запустить камеру: ' + (e && e.message ? e.message : String(e)));
          btnStart.disabled = false;
          return;
        }

        btnStop.disabled = false;
        btnRec.disabled = false;
        setStats();
      }

      function stopAll() {
        btnStop.disabled = true;
        btnRec.disabled = true;

        recording = false;
        btnRec.textContent = '● Запись';
        btnDownload.disabled = (frames.length === 0);
        setStats();

        if (cam) {
          cam.stop();
          cam = null;
        }
        pose = null;

        btnStart.disabled = false;
      }

      function toggleRec() {
        recording = !recording;
        if (recording) {
          frames = [];
          frameCount = 0;
          frameCountDelta = 0;
          lastTs = performance.now();
          btnDownload.disabled = true;
          btnRec.textContent = '■ Стоп запись';
        } else {
          btnRec.textContent = '● Запись';
          btnDownload.disabled = (frames.length === 0);
        }
        setStats();
      }

      function downloadJSON() {
        var payload = {
          version: 'kinexa-web-compat-1',
          createdAt: new Date().toISOString(),
          format: 'mediapipe-pose-landmarks',
          notes: 'x,y normalized [0..1]; z relative; visibility [0..1]',
          frames: frames
        };
        var blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'kinexa_capture_' + Date.now() + '.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Fallback: видеофайл вместо камеры
      async function runOnUploadedVideo(file) {
        showError('');
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnRec.disabled = false;

        initPose();

        // Подставляем файл в <video>
        var url = URL.createObjectURL(file);
        video.srcObject = null;
        video.src = url;
        video.loop = true;
        video.muted = true;

        try {
          await video.play();
        } catch (e) {
          showError('Не удалось воспроизвести видео (браузер запретил autoplay). Нажми Play по видео и попробуй снова.');
        }

        function step() {
          if (!pose) return; // остановлено
          pose.send({ image: video }).catch(function (e) {
            showError('Pose error: ' + (e && e.message ? e.message : String(e)));
          });
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      btnStart.addEventListener('click', function () { startCamera(); });
      btnStop.addEventListener('click', function () { stopAll(); });
      btnRec.addEventListener('click', function () { toggleRec(); });
      btnDownload.addEventListener('click', function () { downloadJSON(); });

      fileVideo.addEventListener('change', function (ev) {
        var f = ev.target.files && ev.target.files[0];
        if (!f) return;
        runOnUploadedVideo(f);
      });

      // Подсказка при загрузке: если не HTTPS — сразу говорим
      if (!isSecureContextForCamera()) {
        showError('Подсказка: камера включится только на HTTPS или localhost.\nЕсли ты открыл файл напрямую — запусти через локальный сервер (python http.server) или залей на HTTPS-хостинг.');
      }
    })();
  </script>
</body>
</html>